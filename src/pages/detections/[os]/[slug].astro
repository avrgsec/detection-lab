---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import fs from 'fs';

export async function getStaticPaths() {
  const detections = await getCollection('detections');
  
  return detections.map((detection) => {
    const [os, filename] = detection.id.split('/');
    const slug = filename.replace('.yml', '');
    
    return {
      params: { os, slug },
      props: { detection },
    };
  });
}

const { detection } = Astro.props;
const { os, slug } = Astro.params;

const osIcons = {
  cve: 'üîí CVE',
  windows: 'ü™ü Windows',
  linux: 'üêß Linux',
  macos: 'üçé macOS',
  cloud: '‚òÅÔ∏è Cloud',
  network: 'üåê Network',
  'cross-platform': 'üîÄ Cross-Platform'
};

const levelColors = {
  critical: 'text-red-500',
  high: 'text-orange-500',
  medium: 'text-yellow-500',
  low: 'text-green-500'
};

function extractMitreTags(tags: string[]): string[] {
  return tags
    .filter(tag => tag.startsWith('attack.'))
    .map(tag => tag.replace('attack.', '').toUpperCase())
    .filter(tag => tag.startsWith('T'));
}

const mitreTags = extractMitreTags(detection.data.tags);
const levelColor = levelColors[detection.data.level.toLowerCase() as keyof typeof levelColors];
const osDisplay = osIcons[os as keyof typeof osIcons] || os;

// Read the original YAML file to preserve field order and formatting
const yamlPath = `src/content/detections/${os}/${slug}.yml`;
const yamlContent = fs.readFileSync(yamlPath, 'utf-8');
---

<BaseLayout title={detection.data.title}>
  <!-- Breadcrumb -->
  <nav class="text-sm text-text-secondary mb-8">
    <a href="/" class="hover:text-text-primary">Home</a>
    <span class="mx-2">/</span>
    <a href="/detections" class="hover:text-text-primary">Detections</a>
    <span class="mx-2">/</span>
    <a href={`/detections#${os}`} class="hover:text-text-primary capitalize">{osDisplay}</a>
    <span class="mx-2">/</span>
    <span class="text-text-primary">{detection.data.title}</span>
  </nav>

  <!-- Header -->
  <div class="mb-12">
    <div class="flex items-center gap-2 text-text-secondary mb-4">
      <span>{osDisplay}</span>
    </div>
    
    <h1 class="text-4xl font-light mb-4">{detection.data.title}</h1>
    
    <p class="text-lg text-text-secondary mb-6">
      {detection.data.description}
    </p>
    
    <!-- Metadata -->
    <div class="flex flex-wrap gap-4 text-sm">
      <div>
        <span class="text-text-secondary">Author:</span>
        <span class="ml-2">{detection.data.author}</span>
      </div>
      <div>
        <span class="text-text-secondary">Date:</span>
        <span class="ml-2">{detection.data.date}</span>
      </div>
      <div>
        <span class="text-text-secondary">Level:</span>
        <span class={`ml-2 ${levelColor}`}>{detection.data.level.toUpperCase()}</span>
      </div>
      {detection.data.status && (
        <div>
          <span class="text-text-secondary">Status:</span>
          <span class="ml-2 capitalize">{detection.data.status}</span>
        </div>
      )}
    </div>
    
    <!-- Tags -->
    {mitreTags.length > 0 && (
      <div class="flex flex-wrap gap-2 mt-6">
        {mitreTags.map(tag => (
          <a 
            href={`https://attack.mitre.org/techniques/${tag.replace('.', '/')}/`}
            target="_blank"
            rel="noopener noreferrer"
            class="px-3 py-1 bg-bg-secondary border border-border rounded hover:border-accent transition-colors text-sm"
          >
            {tag}
          </a>
        ))}
      </div>
    )}
    
    <!-- Download Button -->
    <div class="mt-6">
      <a 
        href={`https://github.com/avrgsec/detection-lab/raw/main/src/content/detections/${os}/${slug}.yml`}
        class="inline-block px-6 py-3 bg-bg-secondary border border-border rounded-lg hover:border-accent transition-colors"
        download
      >
        üì• Download Sigma Rule
      </a>
    </div>
  </div>

  <!-- Sigma Rule -->
  <section class="mb-12">
    <h2 class="text-2xl font-light mb-4">Sigma Rule</h2>
    <div class="bg-bg-secondary border border-border rounded-lg p-6 overflow-x-auto">
      <pre class="text-sm"><code>{yamlContent}</code></pre>
    </div>
  </section>

  <!-- False Positives -->
  {detection.data.falsepositives && detection.data.falsepositives.length > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl font-light mb-4">False Positives</h2>
      <div class="bg-bg-secondary border border-border rounded-lg p-6">
        <ul class="space-y-2 text-text-secondary">
          {detection.data.falsepositives.map(fp => (
            <li class="flex items-start gap-2">
              <span class="text-accent mt-1">‚Ä¢</span>
              <span>{fp}</span>
            </li>
          ))}
        </ul>
      </div>
    </section>
  )}

  <!-- References -->
  {detection.data.references && detection.data.references.length > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl font-light mb-4">References</h2>
      <div class="bg-bg-secondary border border-border rounded-lg p-6">
        <ul class="space-y-2">
          {detection.data.references.map(ref => (
            <li>
              <a 
                href={ref}
                target="_blank"
                rel="noopener noreferrer"
                class="text-text-secondary hover:text-text-primary transition-colors break-all"
              >
                {ref}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </section>
  )}

  <!-- Back Link -->
  <div class="pt-8 border-t border-border">
    <a href="/detections" class="text-text-secondary hover:text-text-primary transition-colors">
      ‚Üê Back to all detections
    </a>
  </div>
</BaseLayout>